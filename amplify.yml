version: 3
frontend:
  phases:
    preBuild:
      commands: 
        - export NODE_OPTIONS="--max-old-space-size=12288"
        - export NEXT_DISABLE_TYPE_CHECKING=true
        - npm ci
    build:
      commands:
        - '[ -f .env ] && (echo "✅ .env file found:" && cat .env && cat .env >> .env.production) || echo "❌ .env file not found."'
        - env | grep -e NODE_ENV -e ENV -e APP_ENV -e REGION -e AWS_REGION  -e FRONTEND_SECRET_NAME | tee -a .env.production | grep . || echo "Some env vars not found - row 1"
        - env | grep -e IN_CLOUD  -e POSTHOG_KEY -e NEXT_PUBLIC_WEBSITE_URL | tee -a .env.production | grep . || echo "Some env vars not found - row 3"
        - env | grep -e SUPPORT_EMAIL_ADDRESS -e CUSTOM_EMAIL_TOKEN_ID -e API_FUNCTION_NAME | tee -a .env.production | grep . || echo "Some env vars not found - row 4"
        - env | grep -e NEXT_PUBLIC_ | tee -a .env.production | grep . || echo "Some env vars not found - row 5"
        - npm run build
        - npm prune --omit=dev
        #- rm -rf node_modules
        #- npm ci --production=true
          
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - node_modules/**/*